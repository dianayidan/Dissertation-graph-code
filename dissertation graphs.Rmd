---
title: "mercury leaf analysis"
author: "Yidan Zhang"
date: "2025-08-10"
output: html_document
---

# Collection date (2024-2025 growing season) -leaf part : 3.1.1.1used 0826
```{r}

library(tidyverse)
library(lubridate)
library(scales)

df_raw <- read.csv("Gb_seasonality.csv", stringsAsFactors = FALSE)

df <- df_raw %>%
  mutate(
    # CSV 的 Month 为 dd/mm/yyyy
    Month      = dmy(Month),
    # 仅保留“月-日”，忽略年份；
    md         = format(Month, "%m-%d"),
    Month_ref  = as.Date(paste0("2001-", md)),
    Tree       = factor(Tree, levels = c("North","South")),
    leaf_parts = factor(leaf_parts, levels = c("P1","P2","P3")),
    `Leaf Orientation` = factor(Leaf_Orientation, levels = c("North","South")),
    Average_Hg = as.numeric(Average_Hg)
  ) %>%
  filter(!is.na(Month_ref), !is.na(Tree), !is.na(leaf_parts), !is.na(Average_Hg))

# ----- 2) Aggregate across Leaf Orientation: mean & sd -----
sum_day <- df %>%
  group_by(Tree, leaf_parts, Month_ref) %>%
  summarise(
    n    = n(),
    mean = mean(Average_Hg, na.rm = TRUE),
    sd   = sd(Average_Hg,   na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    sd   = ifelse(is.na(sd), 0, sd),  
    ymin = pmax(mean - sd, 0),
    ymax = mean + sd
  ) %>%
  arrange(Month_ref)

# presenting date
x_breaks <- sum_day %>%
  distinct(Month_ref) %>%
  arrange(Month_ref) %>%
  pull(Month_ref)

cols <- c("P1" = "#E76F51", "P2" = "#2A9D8F", "P3" = "#277DA1")

theme_paper <- theme_minimal(base_size = 13) +
  theme(
    plot.title.position = "plot",
    plot.title = element_text(face = "bold"),
    axis.title = element_text(face = "bold"),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_line(linewidth = 0.25),
    panel.background  = element_rect(fill = "#FAFAFA", colour = NA),
    strip.background  = element_rect(fill = "#EFEFEF", colour = NA),
    strip.text = element_text(face = "bold"),
    legend.position = "right",
    legend.title = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1) 
  )

x_scale <- scale_x_date(
  breaks = x_breaks,             # 只显示 CSV 实际的周采样日期
  date_labels = "%m-%d",         # 不显示年份
  limits = range(x_breaks),
  expand = expansion(mult = c(0.01, 0.03))
)

# North vs South -----
p_facet <- ggplot(sum_day, aes(Month_ref, mean, colour = leaf_parts, fill = leaf_parts)) +
  geom_ribbon(aes(ymin = ymin, ymax = ymax), alpha = 0.18, colour = NA, show.legend = FALSE) +
  geom_line(linewidth = 0.9) +
  geom_point(size = 1.8, stroke = 0.2) +
  facet_grid(Tree ~ ., scales = "free_y") +
  x_scale +
  scale_colour_manual(values = cols, name = "Leaf Part") +
  scale_fill_manual(values = cols,   name = "Leaf Part") +
  labs(
    title = "Foliar Mercury concentration",
    x = "Collection date (2024-2025 growing season)",
    y = "Hg concentration (ppb)"
  ) +
  theme_paper

# ----- 4B) North -----
df_north <- sum_day %>% filter(Tree == "North")
p_north <- ggplot(df_north, aes(Month_ref, mean, colour = leaf_parts, fill = leaf_parts)) +
  geom_ribbon(aes(ymin = ymin, ymax = ymax), alpha = 0.18, colour = NA, show.legend = FALSE) +
  geom_line(linewidth = 0.9) +
  geom_point(size = 1.8, stroke = 0.2) +
  x_scale +
  scale_colour_manual(values = cols, name = "Leaf Part") +
  scale_fill_manual(values = cols,   name = "Leaf Part") +
  labs(
    title = "Foliar Mercury concentration (North tree)",
    x = "Collection date (2024-2025 growing season)",
    y = "Hg concentration (ppb)"
  ) +
  theme_paper

# ----- 4C) South -----
df_south <- sum_day %>% filter(Tree == "South")
p_south <- ggplot(df_south, aes(Month_ref, mean, colour = leaf_parts, fill = leaf_parts)) +
  geom_ribbon(aes(ymin = ymin, ymax = ymax), alpha = 0.18, colour = NA, show.legend = FALSE) +
  geom_line(linewidth = 0.9) +
  geom_point(size = 1.8, stroke = 0.2) +
  x_scale +
  scale_colour_manual(values = cols, name = "Leaf Part") +
  scale_fill_manual(values = cols,   name = "Leaf Part") +
  labs(
    title = " Foliar Mercury concentration (South Tree) ",
    x = "Collection date (2024-2025 growing season)",
    y = "Hg concentration (ppb)"
  ) +
  theme_paper

print(p_facet)
print(p_north)
print(p_south)

# ----- 6) Save (可选) -----
# ggsave("Hg_mean_sd_facet_monthonly.png", p_facet, width = 11, height = 7, dpi = 300)
# ggsave("Hg_mean_sd_north_monthonly.png", p_north, width = 8, height = 5.5, dpi = 300)
# ggsave("Hg_mean_sd_south_monthonly.png", p_south, width = 8, height = 5.5, dpi = 300)

```



#3.1.1.2 hg ratio 0826
```{r}

library(tidyverse)
library(lubridate)

df <- read.csv("Gb_seasonality.csv", stringsAsFactors = FALSE)
df$Month       <- as.Date(df$Month, format = "%d/%m/%Y")
df$Month_only  <- format(df$Month, "%m-%d")
df$Month_date  <- as.Date(paste0("2024-", df$Month_only), format = "%Y-%m-%d")

df <- df %>%
  filter(Month_date >= as.Date("2024-04-01"),
         Month_date <= as.Date("2024-11-30"))

df <- df %>%
  mutate(
    leaf_parts       = toupper(trimws(leaf_parts)),
    Tree             = factor(Tree, levels = c("North","South")),
    Leaf_Orientation = factor(Leaf_Orientation, levels = c("North","South"))
  )

# 保证同一天×同树×同朝向下 P1/P2/P3 配对 ====
wide <- df %>%
  filter(leaf_parts %in% c("P1","P2","P3")) %>%
  group_by(Month_date, Tree, Leaf_Orientation, leaf_parts) %>%
  summarise(Hg = mean(Average_Hg, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(names_from = leaf_parts, values_from = Hg) %>%
  drop_na(P1, P2, P3)

ratio_long <- wide %>%
  transmute(
    Month_date, Tree, Leaf_Orientation,
    `P1/P2` = P1 / P2,
    `P1/P3` = P1 / P3,
    `P2/P3` = P2 / P3
  ) %>%
  pivot_longer(cols = c(`P1/P2`,`P1/P3`,`P2/P3`),
               names_to = "type", values_to = "ratio")

ratio_long <- ratio_long %>% filter(type %in% c("P1/P2","P2/P3"))

ratio_sum <- ratio_long %>%
  group_by(Month_date, Tree, type) %>%
  summarise(
    n    = n(),
    mean = mean(ratio, na.rm = TRUE),
    sd   = sd(ratio,   na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    sd   = ifelse(is.na(sd), 0, sd),  
    ymin = pmax(mean - sd, 0),        
    ymax = mean + sd,
    type = factor(type, levels = c("P1/P2","P2/P3","P1/P3"))
  )

# CSV 实际出现过的“周”日期（忽略年份，仅按月-日顺序）====  
x_breaks <- ratio_sum %>%
  distinct(Month_date) %>%
  arrange(Month_date) %>%
  pull(Month_date)
cols <- c("P1/P2" = "#E76F51", "P2/P3" = "#277DA1", "P1/P3" = "#2A9D8F")

theme_paper <- theme_minimal(base_size = 13) +
  theme(
    plot.title.position = "plot",
    plot.title = element_text(face = "bold"),
    axis.title  = element_text(face = "bold"),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_line(linewidth = 0.25),
    panel.background  = element_rect(fill = "#FAFAFA", colour = NA),
    strip.background  = element_rect(fill = "#EFEFEF", colour = NA),
    strip.text = element_text(face = "bold"),
    legend.title = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

# 绘图：North / South 分面 + 均值折线 + SD 阴影 
p <- ggplot(ratio_sum, aes(x = Month_date, y = mean, colour = type, fill = type)) +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, alpha = 0.6) +
  geom_ribbon(aes(ymin = ymin, ymax = ymax), alpha = 0.16, colour = NA, show.legend = FALSE) +
  geom_line(linewidth = 1) +
  geom_point(size = 1.6) +
  facet_grid(Tree ~ ., scales = "fixed") +   # 若需要各自独立纵轴，改为 "free_y"
  scale_colour_manual(values = cols, name = "Hg Ratio") +
  scale_fill_manual(values = cols,   name = "Hg Ratio") +
  scale_x_date(
    breaks = x_breaks,               # ★ 用 CSV 实际周日期做刻度
    date_labels = "%m-%d",           # ★ 只显示“月-日”（忽略年份）
    limits = range(x_breaks),
    expand = expansion(mult = c(0.01, 0.03))
  ) +
  labs(
    title = "Seasonal Dynamics of Leaf Hg Ratios (North vs South Trees)",
    x = "Collection date (2024-2025 growing season) ",
    y = "Within different leaf parts Hg Ratio "
  ) +
  theme_paper

print(p)

ggsave("Hg_ratio_North_vs_South.png", p, width = 10.5, height = 6, dpi = 300)

# x_breaks2 <- x_breaks[seq(1, length(x_breaks), by = 2)]
# p + scale_x_date(breaks = x_breaks2, date_labels = "%m-%d",
#                  limits = range(x_breaks), expand = expansion(mult = c(0.01, 0.03)))

```


# 0826 leaf orientation
```{r}
library(tidyverse)
library(lubridate)

df <- read.csv("Gb_seasonality.csv", stringsAsFactors = FALSE)

df$Month      <- as.Date(df$Month, format = "%d/%m/%Y")     # CSV: dd/mm/yyyy
df$Month_only <- format(df$Month, "%m-%d")                  # 只取月-日
df$Month_date <- as.Date(paste0("2024-", df$Month_only))    # 映射到同一年以“只按月份排序”

df <- df %>%
  filter(Month_date >= as.Date("2024-04-01"),
         Month_date <= as.Date("2024-11-30"))

col_ori  <- names(df)[grepl("leaf[_ ]?orientation", names(df), ignore.case = TRUE)][1]
col_tree <- names(df)[grepl("^tree$",               names(df), ignore.case = TRUE)][1]

df <- df %>%
  mutate(
    !!col_tree := factor(.data[[col_tree]], levels = c("North","South")),
    !!col_ori  := factor(.data[[col_ori]],  levels = c("North","South")),
    leaf_parts = toupper(trimws(leaf_parts))
  )

agg_df <- df %>%
  filter(leaf_parts %in% c("P1","P2","P3")) %>%
  group_by(Month_date, .data[[col_tree]], .data[[col_ori]]) %>%
  summarise(
    n    = n(),
    mean = mean(Average_Hg, na.rm = TRUE),
    sd   = sd(Average_Hg,   na.rm = TRUE),
    .groups = "drop"
  ) %>%
  rename(Tree = !!col_tree, Leaf_Orientation = !!col_ori) %>%
  mutate(
    sd   = replace_na(sd, 0),        # 单样本 sd=NA 时置 0，保证 ribbon 可绘制
    ymin = pmax(mean - sd, 0),
    ymax = mean + sd
  ) %>%
  arrange(Month_date)

x_breaks <- agg_df %>%
  distinct(Month_date) %>%
  arrange(Month_date) %>%
  pull(Month_date)

cols_orient <- c("North" = "#E76F51", "South" = "#277DA1")

theme_paper <- theme_minimal(base_size = 13) +
  theme(
    plot.title.position = "plot",
    plot.title = element_text(face = "bold"),
    axis.title  = element_text(face = "bold"),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_line(linewidth = 0.25),
    panel.background  = element_rect(fill = "#FAFAFA", colour = NA),
    strip.background  = element_rect(fill = "#EFEFEF", colour = NA),
    strip.text = element_text(face = "bold"),
    legend.position = "right",
    legend.title    = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

p_facet <- ggplot(agg_df, aes(Month_date, mean, colour = Leaf_Orientation, fill = Leaf_Orientation)) +
  geom_ribbon(aes(ymin = ymin, ymax = ymax), alpha = 0.18, colour = NA, show.legend = FALSE) +
  geom_line(linewidth = 1) +
  geom_point(size = 1.8, stroke = 0.2) +
  facet_wrap(~ Tree, ncol = 1, scales = "fixed") +
  scale_colour_manual(values = cols_orient, name = "Leaf Orientation") +
  scale_fill_manual(values    = cols_orient, name = "Leaf Orientation") +
  scale_x_date(
    breaks = x_breaks,              # ★ 仅显示 CSV 周采样日
    date_labels = "%m-%d",          # ★ 只显示“月-日”，不看年份
    limits = range(x_breaks),
    expand = expansion(mult = c(0.01, 0.03))
  ) +
  labs(
    title = "Foliar Mercury concentration (Month-Only Axis)",
    x = "Collection date (2024-2025 growing season)",
    y = "Hg concentration (ppb)"            # ← 按需改单位
  ) +
  theme_paper

print(p_facet)
ggsave("hg_by_orientation_facet_paper_monthonly.png", p_facet, width = 10.5, height = 7, dpi = 300)

plot_single <- function(tree_name){
  dat <- agg_df %>% filter(Tree == tree_name)
  ggplot(dat, aes(Month_date, mean, colour = Leaf_Orientation, fill = Leaf_Orientation)) +
    geom_ribbon(aes(ymin = ymin, ymax = ymax), alpha = 0.18, colour = NA, show.legend = FALSE) +
    geom_line(linewidth = 1) +
    geom_point(size = 1.9) +
    scale_colour_manual(values = cols_orient, name = "Leaf Orientation") +
    scale_fill_manual(values    = cols_orient, name = "Leaf Orientation") +
    scale_x_date(
      breaks = x_breaks, date_labels = "%m-%d",
      limits = range(x_breaks), expand = expansion(mult = c(0.01, 0.03))
    ) +
    labs(
      title = paste0("Foliar Mercury concentration ", tree_name, " Tree "),
      x = "Collection date (2024-2025 growing season)",
      y = "Hg concentration (ppb)"
    ) +
    theme_paper
}

p_north <- plot_single("North")
p_south <- plot_single("South")
print(p_north); print(p_south)
ggsave("hg_by_orientation_North_monthonly.png", p_north, width = 9, height = 5.5, dpi = 300)
ggsave("hg_by_orientation_South_monthonly.png", p_south, width = 9, height = 5.5, dpi = 300)

# x_breaks2 <- x_breaks[seq(1, length(x_breaks), by = 2)]
# p_facet + scale_x_date(breaks = x_breaks2, date_labels = "%m-%d",
#                        limits = range(x_breaks), expand = expansion(mult = c(0.01, 0.03)))

```


